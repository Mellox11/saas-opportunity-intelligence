# Story 4.5: Reddit Post Observability for Analysis Results

## Status
Draft

## Story
**As a** user exploring analysis results,
**I want** to view and interact with the source Reddit posts that generated each opportunity,
**so that** I can validate opportunities by reading the original context and accessing the full Reddit discussions.

## Acceptance Criteria

1. Two-panel layout on analysis results page with opportunities list (60%) and post detail viewer (40%)
2. Clicking any opportunity displays its source Reddit post in the detail panel with full content
3. Post detail panel shows Reddit post title, subreddit, score, comments count, timestamp, and full content
4. "View on Reddit" button opens the original Reddit post in a new tab
5. "View Comments on Reddit" button opens the Reddit post with comments in a new tab  
6. Copy link functionality allows users to copy the Reddit post permalink
7. Post content properly formatted with line breaks and truncated if over 2000 characters
8. Empty state guidance when no post is selected encourages user interaction
9. Loading states with skeleton UI while post data is being fetched
10. Error handling for failed post loads with retry options
11. Responsive design stacks panels vertically on mobile devices
12. Smooth animations for panel transitions and post selection
13. Visual connection indicator shows which opportunity is currently selected
14. Post metadata includes Reddit ID, score, and comment count for reference
15. Component follows existing dark theme design system with Mercury.com styling

## Tasks / Subtasks

- [ ] Task 1: Create PostDetailPanel component (AC: 3, 4, 5, 6, 7, 8, 9, 10, 14)
  - [ ] Subtask 1.1: Build post display UI with title, metadata, and content formatting
  - [ ] Subtask 1.2: Add action buttons for Reddit links and copy functionality  
  - [ ] Subtask 1.3: Implement loading, error, and empty states
  - [ ] Subtask 1.4: Apply Mercury.com dark theme styling with proper spacing

- [ ] Task 2: Update analysis results page layout (AC: 1, 11, 12)
  - [ ] Subtask 2.1: Implement two-panel responsive grid layout (60/40 split)
  - [ ] Subtask 2.2: Add mobile responsive behavior with vertical stacking
  - [ ] Subtask 2.3: Integrate PostDetailPanel component into results page

- [ ] Task 3: Add post selection state management (AC: 2, 13)
  - [ ] Subtask 3.1: Add selectedPostId state to results page
  - [ ] Subtask 3.2: Connect opportunity card clicks to post selection
  - [ ] Subtask 3.3: Add visual selection indicators to opportunity cards

- [ ] Task 4: Enhance opportunity cards with selection (AC: 2, 13)
  - [ ] Subtask 4.1: Add click handlers to opportunity cards for post selection
  - [ ] Subtask 4.2: Add visual states for selected vs unselected cards
  - [ ] Subtask 4.3: Show post preview snippet in opportunity cards

- [ ] Task 5: Implement smooth animations (AC: 12)
  - [ ] Subtask 5.1: Add transition animations for panel layout changes
  - [ ] Subtask 5.2: Add hover and selection animations for opportunity cards
  - [ ] Subtask 5.3: Add slide-in animation for post detail panel

- [ ] Task 6: Add comprehensive testing
  - [ ] Subtask 6.1: Unit tests for PostDetailPanel component
  - [ ] Subtask 6.2: Integration tests for post selection workflow
  - [ ] Subtask 6.3: Accessibility tests for keyboard navigation
  - [ ] Subtask 6.4: Responsive design tests for mobile breakpoints

## Dev Notes

### Previous Story Insights
This story extends Epic 4's focus on user experience optimization by providing Reddit post observability for opportunity validation. It builds on Epic 4's goal of delivering "premium user experience" through enhanced data exploration capabilities. This complements Story 4.1 (Natural Language Chat Interface) by providing direct access to source Reddit posts for deeper context understanding.

### Data Models
Reddit post data is available through the existing `SourcePost` interface and database schema:
[Source: architecture/backend/1-data-models-database-schema.md#reddit-data-storage]

```sql
CREATE TABLE reddit_posts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    analysis_id UUID REFERENCES analyses(id) ON DELETE CASCADE,
    reddit_id VARCHAR(20) UNIQUE NOT NULL,
    subreddit VARCHAR(100) NOT NULL,
    title TEXT NOT NULL,
    content TEXT,
    score INTEGER,
    num_comments INTEGER,
    created_utc TIMESTAMPTZ,
    url TEXT,
    permalink TEXT -- Added for Reddit links
);
```

The existing `SourcePost` interface in the results page provides:
- `id`, `redditId`, `subreddit`, `title`, `content`
- `score`, `numComments`, `createdUtc`
- `url`, `permalink` for Reddit navigation

### Component Specifications
[Source: architecture/frontend/10-component-architecture-design-system.md#component-composition-patterns]

Design system tokens to use:
- Colors: `gray.800` (primary dark), `gray.900` (deeper dark), `primary.600` (brand blue)
- Mercury.com inspired styling with dot grid patterns and professional fintech aesthetic
- Component structure following Card pattern with Header/Content sections
- Motion animations using framer-motion with duration presets (fast: 150ms, normal: 300ms)

### File Locations
[Source: architecture/frontend/9-project-structure-file-organization.md#components-directory-structure]

- New component: `components/ui/post-detail-panel.tsx` (already created)
- Update existing: `app/(dashboard)/analysis/[id]/results/page.tsx` 
- Component follows UI component naming convention (PascalCase)
- Uses existing Card, Button, Badge components from `components/ui/`

### API Specifications
No new API endpoints required. Post data is available through existing opportunity objects:
- Each opportunity includes `sourcePost` property with full Reddit post data
- Permalink construction: `https://reddit.com${post.permalink}`
- Comments URL: `${redditUrl}?sort=top` for sorted comments view

### Technical Constraints
[Source: architecture/frontend/9-project-structure-file-organization.md#file-naming-conventions]

- Component imports follow proximity pattern: ui components → lib utilities → relative imports
- Use existing Tailwind classes consistent with Mercury.com design system
- Maintain existing dark theme color scheme (gray-950, gray-900, gray-800)
- Follow accessibility patterns with proper ARIA labels and keyboard navigation

### Testing Requirements
[Source: architecture/frontend/13-testing-strategy-quality-assurance.md#component-testing-example]

Testing standards to follow:
- Unit tests: Component logic, state management, user interactions
- Integration tests: Post selection workflow, responsive behavior
- Accessibility tests: Keyboard navigation, screen reader support
- Test files: `__tests__/components/ui/post-detail-panel.test.tsx`
- Testing framework: Jest with React Testing Library and jest-axe for accessibility

Coverage requirements:
- Functions: 80% minimum
- Lines: 80% minimum  
- Branches: 80% minimum

## Testing

### Testing Standards
[Source: architecture/frontend/13-testing-strategy-quality-assurance.md]

Test file locations:
- `__tests__/components/ui/post-detail-panel.test.tsx`
- `__tests__/app/analysis/results-page.test.tsx`

Testing frameworks and patterns:
- Jest with React Testing Library for component testing
- jest-axe for accessibility testing
- userEvent for interaction testing
- Mock Next.js router for navigation testing

Specific testing requirements:
- Test post display with various content lengths
- Test empty states and error handling
- Test responsive layout behavior
- Test Reddit link functionality
- Test copy-to-clipboard functionality
- Test keyboard navigation and accessibility

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-16 | 1.0 | Initial story creation for Reddit Post Observability feature | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA Agent_